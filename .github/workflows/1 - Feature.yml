name: Criar Pull Request Automático

on:
  push:
    branches:
      - 'feature/**' # Monitora todas as branches para mudanças

jobs:
  criar-pull-request:
    runs-on: ubuntu-latest

    steps:
      # Checkout do código
      - name: Checkout do código
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Verificar se há mudanças no repositório
      - name: Verificar alterações no código
        id: check_changes
        run: |
          git fetch origin
          if [ -z "$(git diff --name-only origin/${{ github.ref_name }})" ]; then
            echo "Nenhuma alteração detectada."
            echo "has_changes=false" >> $GITHUB_ENV
          else
            echo "Alterações detectadas."
            echo "has_changes=true" >> $GITHUB_ENV
          fi

      # Configurar Git (apenas se houver alterações)
      - name: Configurar Git
        if: env.has_changes == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # Criar Pull Request (apenas se houver alterações)
      - name: Criar Pull Request
        if: env.has_changes == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: development
          title: 'feature: ${{ github.ref_name }}'
          body: |
            Pull request automática criada a partir da branch ${{ github.ref_name }}.
            
            Por favor, revise as alterações e faça merge se estiver tudo correto.
          labels: feature, automated-pr
          branch: ${{ github.ref_name }}
          delete-branch: false

      # Notificar sucesso na criação do Pull Request
      - name: Verificar criação da Pull Request
        if: env.has_changes == 'true' && steps.cpr.outputs.pull-request-number
        run: |
          echo "Pull Request criada com sucesso: #${{ steps.cpr.outputs.pull-request-number }}"

      # Notificar erro em caso de falha no workflow
      - name: Notificar erro
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: 'Ocorreu um erro ao tentar criar a Pull Request automática. Por favor, verifique os logs do workflow para mais detalhes.'
            })
