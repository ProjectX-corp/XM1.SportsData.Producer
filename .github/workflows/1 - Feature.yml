name: Criar Pull Request Autom�tica

on:
  push:
    branches:
      - 'feature/**'

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout do c�digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar se é branch válida para PR
        id: check_branch
        run: |
          # Verifica se é o primeiro commit na branch (criação da branch)
          if [[ $(git rev-list --count HEAD) -eq 1 ]]; then
            echo "is_valid_for_pr=false" >> $GITHUB_OUTPUT
            echo "Branch recém-criada sem commits adicionais. Cancelando o workflow."
            exit 0
          else
            echo "is_valid_for_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Configurar Git
        if: steps.check_branch.outputs.is_new_branch == 'false'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Criar Pull Request
        if: steps.check_branch.outputs.is_new_branch == 'false'
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: development
          title: 'feature: ${{ github.ref_name }}'
          body: |
            Pull request autom�tica criada a partir da branch ${{ github.ref_name }}.
            
            Por favor, revise as altera��es e fa�a merge se estiver tudo correto.
          labels: feature, automated-pr
          branch: ${{ github.ref_name }}
          delete-branch: false

      - name: Verificar cria��o da Pull Request
        if: steps.check_branch.outputs.is_new_branch == 'false' && steps.cpr.outputs.pull-request-number
        run: |
          echo "Pull Request criada com sucesso: #${{ steps.cpr.outputs.pull-request-number }}"

      - name: Notificar erro
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: 'Ocorreu um erro ao tentar criar a Pull Request autom�tica. Por favor, verifique os logs do workflow para mais detalhes.'
            })
